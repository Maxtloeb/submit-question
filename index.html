// Google Apps Script for Trivia Submission and Review

// Handle GET requests (e.g., fetching pending questions)
function doGet(e) {
  const params = e.parameter || {};
  let output;

  if (params.type === 'getPendingQuestions') {
    const sheet = SpreadsheetApp.openById('YOUR_SHEET_ID').getSheetByName('Submissions');
    const data = sheet.getDataRange().getValues();
    // Assuming header row, filter pending rows
    const questions = data.slice(1).map((row, idx) => ({
      rowIndex: idx + 2, // sheet row number
      question: row[0],
      correct: row[1],
      incorrect1: row[2],
      incorrect2: row[3],
      incorrect3: row[4],
      mainCategory: row[5],
      difficulty: row[6],
      codebook: row[7],
      status: row[8],
      submittedDate: row[9]
    })).filter(q => q.status === 'pending');

    output = questions;
  } else {
    output = { error: 'Invalid GET type' };
  }

  return ContentService
    .createTextOutput(JSON.stringify(output))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader('Access-Control-Allow-Origin', '*');
}

// Handle POST requests (submit, approve, reject)
function doPost(e) {
  const request = JSON.parse(e.postData.contents);
  const sheet = SpreadsheetApp.openById('1rPgpVROorXM2sDbCbDQOQHYyeRRRpOVr-j-AyEXZFe8').getSheetByName('Submissions');
  let result = { status: 'error', message: 'Unknown action' };

  if (request.type === 'submitQuestion') {
    sheet.appendRow([
      request.question,
      request.correct,
      request.incorrect1,
      request.incorrect2,
      request.incorrect3,
      request.mainCategory,
      request.difficulty,
      request.codebook,
      'pending',
      request.submittedDate
    ]);
    result = { status: 'success' };

  } else if (request.type === 'approveQuestion' || request.type === 'rejectQuestion') {
    const id = parseInt(request.questionId, 10);
    if (!isNaN(id)) {
      const newStatus = request.type === 'approveQuestion' ? 'approved' : 'rejected';
      sheet.getRange(id, 9).setValue(newStatus);
      result = { status: 'success' };
    }
  }

  return ContentService
    .createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader('Access-Control-Allow-Origin', '*');
}

