<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Structural Trivia Game</title>
  <style>
    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 2rem;
      background-color: #f7faff;
      color: #002b45;
    }
    h1 {
      text-align: center;
      font-size: 3rem;
      font-weight: 800;
      font-family: 'Arial Black', Impact, sans-serif;
      letter-spacing: 0.02em;
      margin-bottom: 1rem;
    }
    .hidden { display: none; }
    .filter-btn {
      margin: 0.3rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 12px;
      background-color: #e6f0ff;
      cursor: pointer;
    }
    .filter-btn.active { background-color: #007acc; color: white; }
    .tab-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      border-radius: 10px 10px 0 0;
      margin-right: 0.5rem;
    }
    .tab-btn.active { background: #007acc; color: white; }
    .tab-content {
      display: none;
      border: 1px solid #ccc;
      border-top: none;
      padding: 1rem;
      background: white;
      border-radius: 0 0 10px 10px;
    }
    .tab-content.active { display: block; }
    .answer-btn {
      display: block;
      width: 100%;
      margin: 0.5rem 0;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      line-height: 1.4;
      border: 2px solid #007acc;
      border-radius: 12px;
      background-color: #fff;
      cursor: pointer;
      text-align: left;
      transition: background-color 0.3s, color 0.3s;
    }
    .answer-btn:hover { background-color: #007acc; color: white; }
    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    .report-table th, .report-table td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    .correct { color: green; font-weight: bold; }
    .incorrect { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Structural Trivia</h1>

  <div id="tabButtons">
    <button class="tab-btn" data-tab="main" onclick="switchTab('main')">Main Categories</button>
    <button class="tab-btn" data-tab="codebook" onclick="switchTab('codebook')">Questions Per Codebook</button>
  </div>

  <div id="main" class="tab-content">
    <div id="mainCategories"></div>
    <div style="margin-top:1rem; display:flex; align-items:center;">
      <label for="difficultyFilterMain">Filter by Difficulty:&nbsp;</label>
      <select id="difficultyFilterMain" onchange="filterByDifficulty('main')">
        <option value="all">All</option>
        <option value="Easy">Easy</option>
        <option value="Medium">Medium</option>
        <option value="Hard">Hard</option>
        <option value="Impossible">Impossible</option>
      </select>
      <label style="margin-left:1rem;">Questions:&nbsp;
        <select id="questionCountMain" onchange="updateCount('main')">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
        </select>
      </label>
      <button onclick="startQuiz()" style="margin-left:auto; padding:0.5rem 1rem;">Start Quiz</button>
    </div>
  </div>

  <div id="codebook" class="tab-content">
    <div id="codebookCategories"></div>
    <div style="margin-top:1rem; display:flex; align-items:center;">
      <label for="difficultyFilterCodebook">Filter by Difficulty:&nbsp;</label>
      <select id="difficultyFilterCodebook" onchange="filterByDifficulty('codebook')">
        <option value="all">All</option>
        <option value="Easy">Easy</option>
        <option value="Medium">Medium</option>
        <option value="Hard">Hard</option>
        <option value="Impossible">Impossible</option>
      </select>
      <label style="margin-left:1rem;">Questions:&nbsp;
        <select id="questionCountCodebook" onchange="updateCount('codebook')">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
        </select>
      </label>
      <button onclick="startQuiz()" style="margin-left:auto; padding:0.5rem 1rem;">Start Quiz</button>
    </div>
  </div>

  <div id="questionContainer" class="hidden"></div>
  <div id="summary"></div>

  <script>
    // Update this to your deployed Web App URL
    const SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';

    const MAIN_CATEGORIES = ['Wood','Concrete','Steel','Masonry','General Engineering','Wind','Seismic','General Code','Other'];
    const CODEBOOK_CATEGORIES = ['ASCE 7','IBC','ACI 318','NDS','TMS 402','AISC','Other'];

    let allQuestions = [], selectedQuestions = [], userResponses = [];
    let currentCategory = 'main', currentIndex = 0, correctCount = 0;
    const selectedDifficulty = { main:'all', codebook:'all' };
    const questionLimit = { main:10, codebook:10 };
    let selectedCategory = null;

    function renderCategories() {
      document.getElementById('mainCategories').innerHTML = MAIN_CATEGORIES
        .map(c => `<button class="filter-btn" onclick="selectCategory('${c}','main',this)">${c}</button>`)
        .join('');
      document.getElementById('codebookCategories').innerHTML = CODEBOOK_CATEGORIES
        .map(c => `<button class="filter-btn" onclick="selectCategory('${c}','codebook',this)">${c}</button>`)
        .join('');
    }
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add('active');
      currentCategory = tab; selectedCategory = null;
    }
    function selectCategory(cat,tab,btn) {
      document.querySelectorAll(`#${tab} .filter-btn`).forEach(b=>b.classList.remove('active'));
      btn.classList.add('active'); selectedCategory = cat;
    }
    function filterByDifficulty(type) {
      selectedDifficulty[type] = document.getElementById(`difficultyFilter${type.charAt(0).toUpperCase()+type.slice(1)}`).value;
    }
    function updateCount(type) {
      questionLimit[type] = +document.getElementById(`questionCount${type.charAt(0).toUpperCase()+type.slice(1)}`).value;
    }

    async function fetchQuestions() {
      const res = await fetch(SCRIPT_URL+'?type=getAllQuestions');
      const json = await res.json();
      allQuestions = json.filter(q => q.approved==='yes');
    }

    async function startQuiz() {
      if(!selectedCategory) return alert('Select a category first');
      if(!allQuestions.length) await fetchQuestions();
      selectedQuestions = allQuestions
        .filter(q => (currentCategory==='main'?q.MainCategory===selectedCategory:(q.codebook||q.Codebook)===selectedCategory)
          && (selectedDifficulty[currentCategory]==='all'||(q.difficulty||q.Difficulty)===selectedDifficulty[currentCategory]))
        .slice(0, questionLimit[currentCategory]);
      currentIndex=0; correctCount=0; userResponses=[];
      document.getElementById('main').classList.add('hidden');
      document.getElementById('codebook').classList.add('hidden');
      document.getElementById('questionContainer').classList.remove('hidden');
      showQuestion();
    }

    function showQuestion(){
      const container = document.getElementById('questionContainer');
      if(currentIndex>=selectedQuestions.length) return showSummary();
      const q=selectedQuestions[currentIndex];
      const answers=[q.correct,q.incorrect1,q.incorrect2,q.incorrect3].filter(Boolean).sort(()=>Math.random()-0.5);
      container.innerHTML=`
        <button onclick="goBack()" style="margin-bottom:1rem;background:#ccc;border:none;padding:0.5rem 1rem;border-radius:8px;">← Back to Categories</button>
        <p><strong>Q${currentIndex+1}:</strong> ${q.question}</p>
        ${answers.map(a=>`<button class="answer-btn" onclick="checkAnswer('${a}','${q.correct}')">${a}</button>`).join('')}
      `;
    }

    function checkAnswer(choice,correct){
      userResponses.push({question:selectedQuestions[currentIndex].question,chosen:choice,correct, isCorrect:choice===correct});
      if(choice===correct) correctCount++;
      currentIndex++; showQuestion();
    }

    function goBack(){
      document.getElementById('questionContainer').classList.add('hidden');
      document.getElementById(currentCategory).classList.remove('active');
    }

    function showSummary(){
      const c=document.getElementById('questionContainer');
      let html=`<h2>Quiz Complete</h2><p>You got ${correctCount} of ${selectedQuestions.length} correct!</p>`;
      html+=`<table class="report-table"><tr><th>Question</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th></tr>`;
      userResponses.forEach(r=>{
        const m=r.isCorrect?'<span class="correct">✓</span>':'<span class="incorrect">✗</span>';
        html+=`<tr><td>${r.question}</td><td>${r.chosen}</td><td>${r.correct}</td><td>${m}</td></tr>`;
      });
      html+='</table>';
      c.innerHTML=html;
    }

    document.addEventListener('DOMContentLoaded',()=>{
      renderCategories();
      switchTab('main');
    });
  </script>
</body>
</html>
